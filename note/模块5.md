# 1 新建表order_info

![image-20210830184527253](D:\截图\image-20210830184527253.png)



~~~java
@Data
public class OrderModel {
    //2018102100012828
    private String id;

    // 购买用户的id
    private Integer userId;

    // 购买商品的id
    private Integer itemId;

    // 购买商品当时的单价
    private BigDecimal itemPrice;

    // 购买数量
    private Integer amount;

    // 购买金额
    private BigDecimal orderPrice;
}
~~~



# 2 插件生成 OrderDO

~~~xml
        <table tableName="order_info" domainObjectName="OrderDO" enableCountByExample="false"
               enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false"
               selectByExampleQueryId="false"></table>
~~~



# 3 下单

**ItemStockMapper.java**

~~~java
    int decreseStock(@Param("itemId") int itemId,@Param("amount") int amount);
~~~

**ItemStockMapper.xml**

~~~xml
  <update id="decreseStock" parameterType="com.wxn.miaosha.dataobject.ItemStockDO">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Aug 30 14:36:58 CST 2021.
    -->
    update item_stock
    set stock = stock - #{amount}
    where item_id = #{itemId} and stock >= #{amount}
  </update>
~~~

**ItemServiceImpl.java**

~~~java
    @Override
    @Transactional
    public boolean decreseStock(Integer itemId, Integer amount) throws BussinessException {
        // affectRow 表示修改影响的条目数
        int affectRow = itemStockDOMapper.decreseStock(itemId,amount);

        // 更新成功
        if(affectRow > 0){
            return true;
        }
        return false;
    }
~~~



# 4 自增序列获取

![image-20210830211253801](D:\截图\image-20210830211253801.png)

**插件生成SequenceDO**

~~~xml
        <table tableName="sequence_info" domainObjectName="SequenceDO" enableCountByExample="false"
               enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false"
               selectByExampleQueryId="false"></table>
~~~



**获取自增id**

> 该函数运用在另一个事务中，但是当该事务成功时，应当需要执行完其中的操作，以此来避免sequence发生重复。
>
> 使用propagation = Propagation.REQUIRES_NEW，表示新开一个事务。

~~~java
@Transactional(propagation = Propagation.REQUIRES_NEW)
     public String generateOrderNo(){
        // 订单号有16位
        StringBuilder stringBuilder = new StringBuilder();
        // 前8位为时间信息，年月日
        LocalDateTime now = LocalDateTime.now();
        String nowDate = now.format(DateTimeFormatter.ISO_DATE).replace("-", "");
        stringBuilder.append(nowDate);

        // 中间6位为自增序列
        SequenceDO sequenceDO = sequenceDOMapper.selectByName("order_info");
        Integer currentValue = sequenceDO.getCurrentValue();
        sequenceDO.setCurrentValue(sequenceDO.getCurrentValue() + sequenceDO.getStep());
        sequenceDOMapper.updateByPrimaryKey(sequenceDO);
        String sequenceStr = String.valueOf(currentValue);
        for(int i = 0;i < 6 - sequenceStr.length();i++){
            stringBuilder.append("0");
        }
        stringBuilder.append(sequenceStr);


        // 最后2位为分库分表位,暂时写死
        stringBuilder.append("00");

        return stringBuilder.toString();
    }
~~~

**实现createOrder**

~~~java
@Override
    @Transactional
    public OrderModel createOrder(Integer userId, Integer itemId, Integer amount) throws BussinessException {
        // 1.校验下单状态，下单商品是否存在，用户是否合法，购买数量是否正确
        ItemModel itemModel = itemService.getItemById(itemId);
        UserModel userModel = userService.getUserById(userId);
        if(itemModel == null || userModel == null || itemModel.getStock() < amount || amount < 0){
            throw new BussinessException(EmBusinessError.PARAMETER_VALIDATION_ERROR,"下单状态错误");
        }

        // 2.落单减库存，支付减库存
        boolean result = itemService.decreseStock(itemId, amount);
        if(!result){
            throw new BussinessException(EmBusinessError.STOCK_NOT_ENOUGH);
        }

        // 3.订单入库
        OrderModel orderModel = new OrderModel();
        orderModel.setItemId(itemId);
        orderModel.setAmount(amount);
        orderModel.setUserId(userId);
        orderModel.setItemPrice(itemModel.getPrice());
        orderModel.setOrderPrice(itemModel.getPrice().multiply(new BigDecimal(amount)));

        // 生成交易流水号
        orderModel.setId(generateOrderNo());

        OrderDO orderDO = convertOrderDOFromModel(orderModel);
        orderDOMapper.insertSelective(orderDO);

        // 4.返回前端
        return orderModel;
    }
~~~



**controller层实现createOrder**

~~~java
// 封装下单请求
    @RequestMapping(value = "/createorder",method = {RequestMethod.POST},consumes = {CONTENT_TYPE_FORMED})
    @ResponseBody
    public CommonReturnType createOrder(@RequestParam(name="itemId")Integer itemId,
                                        @RequestParam(name = "amount")Integer amount) throws BussinessException {
        // 获取用户的登录信息
        Boolean is_login = (Boolean)httpServletRequest.getSession().getAttribute("IS_LOGIN");
        if(is_login == null|| !is_login)
            throw new BussinessException(EmBusinessError.USER_NOT_LOGIN);
        UserModel userModel = (UserModel) httpServletRequest.getSession().getAttribute("LOGIN_USER");


        OrderModel orderModel = orderService.createOrder(userModel.getId(), itemId, amount);
        return CommonReturnType.create(orderModel);
    }
~~~

